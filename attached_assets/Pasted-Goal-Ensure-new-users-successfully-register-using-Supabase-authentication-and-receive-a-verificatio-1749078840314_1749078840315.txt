Goal:
Ensure new users successfully register using Supabase authentication and receive a verification email sent by Supabase's built-in email service. This involves correcting the current registration flow.

Problem Identified:
The primary issue is that the client-side registration process in FragranceMarketplace 2/client/src/hooks/use-auth.tsx attempts to call a backend API endpoint (/api/register-with-verification) which is not defined in your server-side code (FragranceMarketplace 2/server/routes.ts). Consequently, supabase.auth.signUp() is never invoked, and no verification email is sent.

Recommended Solution: Implement Client-Side supabase.auth.signUp()

This approach is generally simpler and leverages the Supabase JS client library directly.

Step 1: Modify Client-Side Registration Logic

File to Edit: FragranceMarketplace 2/client/src/hooks/use-auth.tsx

Action: Update the registerWithVerificationMutation to call supabase.auth.signUp() directly.

// Within FragranceMarketplace 2/client/src/hooks/use-auth.tsx

import { supabase } from '@/lib/supabase'; // Ensure this import points to your Supabase client instance
// ... other imports ...

// Update your RegisterWithVerificationData if needed, e.g., to ensure it has all fields for Supabase
type RegisterWithVerificationData = {
  username: string; // Consider if you need this directly in Supabase auth or just your public table
  email: string;
  password: string;
  firstName?: string | null;
  lastName?: string | null;
};

// Update the mutation
const registerWithVerificationMutation = useMutation({
  mutationFn: async (registrationData: RegisterWithVerificationData) => {
    const { email, password, username, firstName, lastName } = registrationData;

    // Determine the base URL for email redirection dynamically
    // Ensure VITE_SITE_URL is set in your .env file for client-side use
    const siteURL = import.meta.env.VITE_SITE_URL || window.location.origin;
    const redirectURL = `${siteURL}/auth-callback`; // Or your preferred callback page e.g., /verify-email

    console.log(`Attempting Supabase signUp with email: ${email}, redirectURL: ${redirectURL}`);

    const { data, error } = await supabase.auth.signUp({
      email: email,
      password: password,
      options: {
        emailRedirectTo: redirectURL,
        data: { // This data is stored in auth.users.raw_user_meta_data
          username: username,     // Or full_name: `${firstName} ${lastName}`
          first_name: firstName,
          last_name: lastName,
          // You can add other metadata you want to store directly with the Supabase auth user
        }
      }
    });

    if (error) {
      console.error('Supabase signUp error:', error);
      throw error; // Let React Query handle the error
    }

    // data.user will contain the newly created Supabase auth user (but session might be null until verified)
    // data.session will typically be null here because email confirmation is required.
    console.log('Supabase signUp successful (email verification pending):', data);
    return { message: "Registration successful! Please check your email to verify your account.", user: data.user };
  },
  onSuccess: (response) => { // data here is { message, user }
    toast({
      title: "Registration Initiated",
      description: response.message,
    });
    // Navigate to a page informing the user to check their email,
    // or the login page with a message.
    // The auth-page.tsx already has logic for `registration=success`
    setLocation("/auth?tab=login&registration=success"); 
  },
  onError: (error: Error) => {
    toast({
      title: "Registration Failed",
      description: error.message || "An unknown error occurred.",
      variant: "destructive",
    });
  },
});
Okay, here's a functional prompt to guide you in overhauling your email verification system by fixing the identified error and correctly implementing supabase.auth.signUp():

Subject: Action Plan: Implement Supabase Email Verification for User Registration
Goal: Ensure new users successfully register using Supabase authentication and receive a verification email sent by Supabase's built-in email service. This involves correcting the current registration flow.
Problem Identified: The primary issue is that the client-side registration process in FragranceMarketplace 2/client/src/hooks/use-auth.tsx attempts to call a backend API endpoint (/api/register-with-verification) which is not defined in your server-side code (FragranceMarketplace 2/server/routes.ts). Consequently, supabase.auth.signUp() is never invoked, and no verification email is sent.
Recommended Solution: Implement Client-Side supabase.auth.signUp()
This approach is generally simpler and leverages the Supabase JS client library directly.
Step 1: Modify Client-Side Registration Logic
File to Edit: FragranceMarketplace 2/client/src/hooks/use-auth.tsx


Action: Update the registerWithVerificationMutation to call supabase.auth.signUp() directly.

 TypeScript
// Within FragranceMarketplace 2/client/src/hooks/use-auth.tsx

import { supabase } from '@/lib/supabase'; // Ensure this import points to your Supabase client instance
// ... other imports ...

// Update your RegisterWithVerificationData if needed, e.g., to ensure it has all fields for Supabase
type RegisterWithVerificationData = {
  username: string; // Consider if you need this directly in Supabase auth or just your public table
  email: string;
  password: string;
  firstName?: string | null;
  lastName?: string | null;
};

// Update the mutation
const registerWithVerificationMutation = useMutation({
  mutationFn: async (registrationData: RegisterWithVerificationData) => {
    const { email, password, username, firstName, lastName } = registrationData;

    // Determine the base URL for email redirection dynamically
    // Ensure VITE_SITE_URL is set in your .env file for client-side use
    const siteURL = import.meta.env.VITE_SITE_URL || window.location.origin;
    const redirectURL = `${siteURL}/auth-callback`; // Or your preferred callback page e.g., /verify-email

    console.log(`Attempting Supabase signUp with email: ${email}, redirectURL: ${redirectURL}`);

    const { data, error } = await supabase.auth.signUp({
      email: email,
      password: password,
      options: {
        emailRedirectTo: redirectURL,
        data: { // This data is stored in auth.users.raw_user_meta_data
          username: username,     // Or full_name: `${firstName} ${lastName}`
          first_name: firstName,
          last_name: lastName,
          // You can add other metadata you want to store directly with the Supabase auth user
        }
      }
    });

    if (error) {
      console.error('Supabase signUp error:', error);
      throw error; // Let React Query handle the error
    }

    // data.user will contain the newly created Supabase auth user (but session might be null until verified)
    // data.session will typically be null here because email confirmation is required.
    console.log('Supabase signUp successful (email verification pending):', data);
    return { message: "Registration successful! Please check your email to verify your account.", user: data.user };
  },
  onSuccess: (response) => { // data here is { message, user }
    toast({
      title: "Registration Initiated",
      description: response.message,
    });
    // Navigate to a page informing the user to check their email,
    // or the login page with a message.
    // The auth-page.tsx already has logic for `registration=success`
    setLocation("/auth?tab=login&registration=success"); 
  },
  onError: (error: Error) => {
    toast({
      title: "Registration Failed",
      description: error.message || "An unknown error occurred.",
      variant: "destructive",
    });
  },
});


Step 2: Ensure Client-Side Supabase Client is Correctly Initialized
File to Check: FragranceMarketplace 2/client/src/lib/supabase.ts
Action: Verify that your Supabase client is initialized with your project URL and anon key. These should typically come from environment variables (e.g., import.meta.env.VITE_SUPABASE_URL, import.meta.env.VITE_SUPABASE_ANON_KEY).
Step 3: Update Call in Auth Page (Verify)
File to Check: FragranceMarketplace 2/client/src/pages/auth-page.tsx
Action: The onRegisterSubmit function already calls signUpMutation.mutate. Ensure the data passed matches the RegisterWithVerificationData type used in use-auth.tsx. The existing structure seems fine:
// From FragranceMarketplace 2/client/src/pages/auth-page.tsx
// const { confirmPassword, terms, ...registerData } = data;
// signUpMutation.mutate({ // This 'signUpMutation' is 'registerWithVerificationMutation' from use-auth
//   username: registerData.username,
//   email: registerData.email,
//   password: registerData.password,
//   firstName: registerData.firstName,
//   lastName: registerData.lastName
// });

Step 4: Handle User Profile Creation in Your Public Table (Post-Verification)

